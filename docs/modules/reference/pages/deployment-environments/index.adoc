Installation
------------

FormKiQ was built using the https://aws.amazon.com/serverless/sam[AWS Serverless Application Model (SAM)] framework.

https://github.com/formkiq/formkiq-core[FormKiQ Core] uses AWS resources, including DynamoDB, CloudFront, Lambda functions, and API Gateway. These resources are defined in the `template.yaml` file in this project. You can customize FormKiQ by updating the template and adding AWS resources through the same deployment process that updates your application code.

**A Note about AWS Accounts:** we recommend creating a dev or staging account as well as a prod account, as opposed to deploying two instances of FormKiQ with different stages/environments. This isn't due to any issues with running two FormKiQ instances, but to help better separate your non-prod integration from your production instance.

To have more than one account, you can set up a new AWS account to be your organization management account, and then use AWS Organizations to add two or more additional accounts, one for each stage/environment you plan to use. If you have an existing AWS account with active AWS services/resources, you should import that into a new management account, rather than use that account as your management account, as AWS Best Practices is to not run workloads in your management account.

FormKiQ can be installed either through a `Single Click` or using the `SAM CLI`. See instructions below for installation options.

=== Single Click Installation

video::jVIK2ZJZsKE[youtube,title=Install FormKiQ Core into any AWS Account,width=640,height=480]

The easiest way to install FormKiQ is via the single click the installation link found on the https://github.com/formkiq/formkiq-core[FormKiQ Core] GitHub page. The link will automatically launch you into your AWS console and autocomplete the FormKiQ installation url.

image::github-click-install.png[GitHub Click Install,300,300]

For FormKiQ Enterprise users, you'll find the same single click installation url in your custom https://github.com[GitHub] repository you were provided.

image::github-enterprise-install.png[GitHub Enterprise Click Install,600,600]

==== CloudFormation Create Stack

image::cf-createstack.png[CloudFormation Create Stack,600,600]

After clicking the FormKiQ installation link, you'll be brought into the AWS CloudFormation Console. From here you'll be able to customize your FormKiQ settings.

Follow the CloudFormation screens to install FormKiQ.

=== SAM CLI Installation

==== Download

The latest version of FormKiQ Core can be found on the https://github.com/formkiq/formkiq-core/releases[FormKiQ Core Releases page on GitHub]. Download the source code (tar.gz or zip) to your local computer and expand/unzip into its own folder, `formkiq-core-x.x.x`.

==== Deploy

The Serverless Application Model Command Line Interface (SAM CLI) is an extension of the AWS CLI that adds functionality for deploying serverless applications.

To use SAM CLI, you will need to install the following tools:

* AWS CLI - https://aws.amazon.com/cli[Install the AWS CLI]
* SAM CLI - https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html[Install the SAM CLI]

To deploy FormKiQ Core for the first time, run the following in your shell from the root of this formkiq-core-x.x.x folder:

```bash
sam deploy --guided --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND CAPABILITY_NAMED_IAM
```

The command will package and deploy your application to AWS, with a series of prompts:

* **Stack Name**: the name of the stack to deploy to CloudFormation; this should be unique to your account and region, and a good starting point would be `formkiq-core-&lt;AppEnvironment&gt;` where AppEnvironment matches your installation environment, e.g. prod, dev, test
* **AWS Region**: the AWS region you want to deploy your app to
* **AdminEmail**: the Administration Email you want FormKiQ to use
* **AppEnvironment**: your installation environment, e.g. prod, dev, test; must be unique per account
* **EnablePublicUrls**: whether to Enable `/public/` urls.
* **PasswordMinimumLength**: the minimum Password Length for User Accounts
* **PasswordRequireLowercase**: whether at least one lowercase letter is required in User Passwords
* **PasswordRequireNumbers**: whether at least one number is required in User Passwords
* **PasswordRequireSymbols**: whether at least one symbol is required in User Passwords
* **PasswordRequireUppercase**: whether at least one uppercase letter is required in User Passwords
* **Confirm changes before deploy**: if set to yes, any change sets will be shown to you before execution for manual review; if set to no, the AWS SAM CLI will automatically deploy application changes
* **Allow SAM CLI IAM role creation**: FormKiQ Core's AWS SAM templates create AWS IAM roles required for the AWS Lambda function(s) included to access AWS services; the permissions are passed in by the `sam deploy` command above, so **this value should be set to "Y"**
* **Save arguments to samconfig.toml**: if set to "Y", your choices will be saved to a configuration file inside the project, so that in the future you can just re-run `sam deploy` without parameters to deploy changes to your application

Once you have set all of these options, SAM CLI will create a changeset and will display a list of all actions that will be performed as part of the changeset. If you have set "confirm changes before deploy" to "Y", you will then be asked whether or nor to deploy this changeset. Choose "Y" to complete the installation.

Once the FormKiQ Core stack has been deployed, you will be able to find your two available API Gateway Endpoint URLs (HTTP/Cognito and IAM) in the output values displayed after deployment.

==== Outputs

After the FormKiQ Cloudformation Stack completes, output values from the deployment are made available in the CloudFormation Outputs and in the SSM Parameter Store. Below you'll find a description of the outputs.

**CloudFormation Outputs**

|=======================================================================
| Key | Description                
| `CognitoClientId` | Cognito Client Id
| `CognitoUserPoolId` | Cognito User Pool Id
| `ConsoleUrl` | The URL for the FormKiQ Console
| `FormKiQVersion` | FormKiQ Version
| `HttpApiUrl` | The URL for the API endpoint that uses Cognito authorization
| `IamApiUrl` | The URL for the API endpoint that uses IAM authorization
|=======================================================================

**SSM Parameter Store**

SSM parameters made it easy for applications to automatically look up FormKiQ configuration settings. All configuration keys start with '/formkiq/&#123;AppEnvironment&#125;'

|=======================================================================
| Parameter | Description                
| `api/DocumentsHttpUrl` | The URL for the API endpoint that uses Cognito authorization
| `api/DocumentsIamUrl` | The URL for the API endpoint that uses IAM authorization
| `cognito/AdminGroup` | Cognito Admin Group
| `cognito/IdentityPoolId` | Cognito Identity Pool
| `cognito/UserPoolArn` | Cognito User Pool Arn
| `cognito/UserPoolClientId` | Cognito User Pool Client
| `cognito/UserPoolId` | Cognito User Pool
| `cognito/UserPoolProviderName` | Cognito User Pool Provider Name
| `cognito/UserPoolProviderUrl` | Cognito User Pool Provider URL
| `console/AdminEmail` | Console Admin Email
| `console/Url` | The URL for the FormKiQ Console
| `console/version` | Console Version
| `dynamodb/CacheTableName` | DynamoDB Cache table name
| `dynamodb/DocumentsTableName` | DynamoDB Documents table name
| `iam/ApiGatewayInvokeGroup` | API Gateway Group that allows invoking of endpoints
| `iam/ApiGatewayInvokeGroupArn` | API Gateway Group Arn that allows invoking of endpoints
| `iam/ApiGatewayInvokeRole` | API Gateway Role that allows invoking of endpoints
| `iam/ApiGatewayInvokeRoleArn` | API Gateway Role Arn that allows invoking of endpoints
| `lambda/ConsoleInstaller` | Lambda for Console Installation
| `lambda/DocumentsApiRequests` | Lambda for processing API Requests
| `lambda/DocumentsUpdateObject` | Lambda for processing Document Update Events
| `lambda/StagingCreateObject` | Lambda for processing Staging Document Create Events
| `region` | Deployment Region
| `s3/Console` | Console S3 Bucket
| `s3/ConsoleArn` | Console S3 Bucket Arn
| `s3/ConsoleDomainName` | Console S3 Bucket Domain Name
| `s3/ConsoleRegionalDomainName` | Console S3 Bucket Regional Domain Name
| `s3/DocumentsS3Bucket` | Documents S3 Bucket Name
| `s3/DocumentsStageS3Bucket` | Documents Staging S3 Bucket Name
| `sns/SnsDocumentsCreateEventTopicArn` | SNS Topic for Document Create Events
| `sns/SnsDocumentsDeleteEventTopicArn` | SNS Topic for Document Delete Events
| `sns/SnsDocumentsUpdateEventTopicArn` | SNS Topic for Document Update Events
| `sqs/DocumentsUpdateArn` | SQS ARN for processing Document Update Events  
| `sqs/DocumentsUpdateUrl` | SQS URL for processing Document Update Events
| `version` | FormKiQ Stacks Version
|=======================================================================

=== Uninstall

FormKiQ uses https://aws.amazon.com/cloudformation[AWS CloudFormation] to provision all resources. Uninstalling FormKiQ is as easy as logging into the https://us-east-1.console.aws.amazon.com/cloudformation/home[AWS CloudFormation Console] and deleting the `formkiq-core` stack.

Alternatively, you can use the AWS CLI. Assuming you used the suggested stack name (formkiq-core-&lt;AppEnvironment&gt;) for the stack name, you can run the following:

```bash
aws cloudformation delete-stack --stack-name formkiq-core-&lt;AppEnvironment&gt;
```

=== Upgrading

FormKiQ is designed to be N-1 compatible for updates, with automatic upgrades of database schema and other components whenever possible.
