Single Sign-On and Custom JWT Authorizer Module
-----------------------------------------------

image::saml-architecture.svg[SAML Architecture,700,700]

Single Sign-On and Custom JWT Authorizer is a FormKiQ Enterprise Add-On Module (for the FormKiQ Core Headless Document Management System) that enables the ability to customize the authorizer used for FormKiQ console, and API endpoints.

FormKiQ by default uses https://aws.amazon.com/cognito[Amazon Cognito] as the JWT authorizer.

Using this module the authorizer can be changed to another authorizer such as:

* Another JWT authorizer such as https://auth0.com[Auth0]

* SAML identity providers through Security Assertion Markup Language 2.0 (SAML 2.0)

* Public providers: https://docs.aws.amazon.com/cognito/latest/developerguide/facebook.html[FaceBook], https://docs.aws.amazon.com/cognito/latest/developerguide/google.html[Google], or https://docs.aws.amazon.com/cognito/latest/developerguide/apple.html[Apple]

* OpenID Connect provider

====
_**Use Case:**_
[loweralpha] 
. _If you would like to maintain your ActiveDirectory or Google Apps login from your organization into the FormKiQ API or Console, this module allows that with minimal configuration_
====

=== Integration Instructions - Microsoft Active Directory Federation Services

==== Retrieve Your Amazon Cognito Info

In order to configure your Windows Server AD FS, you will need to retrieve your FormKiQ Pool ID and Amazon Cognito Domain.

Go to Amazon Cognito in your AWS Management Console. Under "Settings", you can retrieve your User Pool ID:

image::cognito-user-pool-settings.png['Cognito User Pool Settings',700]

You can then retrieve your Cognito Domain under "App Integration >> Domain Name":

image::cognito-user-pool-domain.png['Cognito User Pool Domain']


==== Open AD FS Management in Windows Server Manager

**NOTE:** Ensure that 

- AD FS server(s) has https network access to `amazoncognito.com`

- When using multiple AD FS servers, apply the following changes to all servers 

Go to "Server Manager" and select "AD FS":

image::windows-server-manager-dashboard.png['Windows Server Manager Dashboard']

Choose the "Tools" menu, and select "AD FS Management":

image::windows-adfs-tools-ad-fs-management.png['Windows Server Manager - AD FS Management',700]


==== Adding Relying Party Trust Management

Select "Relying Party Trusts" and choose the "Add Relying Party Trust Wizard". Choose the default "Claims aware" option:

image::ad-fs-trust-wizard-claims-aware.png['Claims Aware Relying Party Trust']

For "Select Data Source", choose the option "Enter data about the relying party manually":

image::ad-fs-trust-wizard-data-source.png['Choosing the manual data source option']

For "Specify Display Name", enter a descriptive name, such as "FormKiQ ADFS Login":

image:ad-fs-trust-wizard-display-name.png['Choosing a descriptive name']

For "Configure URL", choose "Enable support for the SAML 2.0 WebSSO protocol", and for the form field below, replace "yourDomainPrefix" with your Amazon Cognito User Pool's Domain Prefix (retrieved as the first step), and replace region with the User Pool's AWS Region (for example, "us-east-1"):

image::ad-fs-trust-wizard-configure-url.png['Configuring the URL']

For "Configure Identifiers", you need to supply the "Relying party trust identifier". Enter "urn:amazon:cognito:sp:*yourUserPoolID*" as the URN, but with your Cognito User Pool (e.g., "us-east-1_g2zxiEbac"), instead of "*yourUserPoolId*":

image::ad-fs-trust-wizard-configure-identifiers.png['Configuring the Trust Identifier']

You can now click through the default options for the remainder of the Wizard and click "Finish".

==== Editing the Relying Party Trust Claim Issuance Policy

You should now see your new Relying Party Trust listed with the Display Name that you provided. You can select this trust:

image::ad-fs-relying-party-trust.png['Selecting Your Relying Party Trust']

Choose "Edit Claim Issuance Policy":

image::ad-fs-edit-claim-issuance-policy.png['Editing Your Claim Issuance Policy']

You can now add a new Claim Issuance Policy Rule for the Windows account name:

image::ad-fs-claim-issuance-add-name-rule.png['Adding a new Claim Issuance Policy Rule for Windows account name']

Next, create a rule for the email:

image::ad-fs-claim-issuance-add-email-rule.png['Adding a new Claim Issuance Policy Rule for Email']

==== Signing in with AD FS

You can test out your AD sign in with the FormKiQ Console:

image::formkiq-console-external-provider-login.png['FormKiQ Console External Provider Login']

You will then be redirected to an Active Directory server and prompted to choose your Corporate ID:

image::formkiq-console-sign-in.png['FormKiQ Console Corporate ID',700]

You can then securely sign in with your Active Directory credentials:

image::formkiq-console-secure-sign-in.png['Signing in Securely with AD',700]


==== User Group Access

FormKiQ access is determined by the group(s) the user belongs to, see https://docs.formkiq.com/docs/1.8.0/reference/README.html#multi-tenant[Multi-Tenant]

The only difference is all user groups need to be prefixed with `formkiq_`.

At a minimum you need to create a group called `formkiq_default` which will give users read / write access to the default siteId.

=== OpenSearch Dashboards/Kibana using SAML Authentication

SAML authentication for OpenSearch Dashboards lets you use your existing identity provider to offer single sign-on (SSO) for Dashboards/Kibana on Amazon OpenSearch Service.

Start by visiting the https://us-east-2.console.aws.amazon.com/opensearch/domains[AWS OpenSearch Console] and selecting the domain to change the authentication source.

Select the `Security configuration` tab and then the `Edit` button.

image::opensearch-security-configuration.png['OpenSearch Security Configuration']

First, Disable Cognito Authentication

image::opensearch-cognito-authentication.png['Cognito Authentication']

Next, Enable SAML authentication

image::opensearch-saml-authentication.png['SAML Authentication']

After enabling SAML authentication, you are provided the following configuration urls:

* Service provider entity ID

* IdP-initiated SSO URL

* SP-initiated SSO URL

Using the above urls to create a new application with SAML support in your IdP. To configure authentication through your IdP's application directory, use the IdP-initiated SSO URL. To configure authentication through the OpenSearch Dashboards/Kibana URL, use the SP-initiated SSO URL.

The following link provides additional information on configuring 
https://docs.aws.amazon.com/opensearch-service/latest/developerguide/saml.html[SAML authentication for OpenSearch Dashboards].

