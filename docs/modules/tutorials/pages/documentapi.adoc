== Getting Started with Document API

This tutorial will take you through the basic of the FormKiQ API including: adding document, document tags and searching for documents.

## Prerequisite

* You have installed FormKiQ, see the xref:tutorials:install.adoc[FormKiQ Installation tutorial]
* Install the https://aws.amazon.com/cli[AWS CLI]
* Install either: cURL or your favorite API Client, like https://www.postman.com[Postman].
* Optionally install: https://stedolan.github.io/jq[JQ], a command-line JSON processor which formats JSON so it is more readable.
* All shell commands are shown for Unix-based systems. Windows has analogous commands for each.


## CloudFormation Outputs

We are going to need to know the name of a few AWS resources creating during the FormKiQ installation. Opening the https://console.aws.amazon.com/cloudformation[CloudFormation console], find your FormKiQ stack and click the `Outputs` tab.

image::cf-outputs.png[CloudFormation Outputs,500,500]

The following are outputs we'll need to know.

|=======================================================================
| Argument | Description                
| `CognitoClientId` | The Cognito Client Id
| `HttpApiUrl` | The URL for the API endpoint that uses Cognito authorization
|=======================================================================

## Cognito Authentication

The first thing we need is a https://jwt.io[JSON Web Tokens (JWT)] that will tell the API we are authorized to make the API request.

Authenticating can be done using https://aws.amazon.com/cli[AWS CLI] with the following command. The descriptions of the required arguments are in the table below.

----
aws cognito-idp initiate-auth --auth-flow USER_PASSWORD_AUTH \
--auth-parameters USERNAME=<ADMIN_EMAIL>,PASSWORD=<PASSWORD> --client-id <CognitoClientId> --region <AWS_REGION>
----

|=======================================================================
| Argument | Description                
| `ADMIN_EMAIL` | The administrator email address used when installing FormKiQ.
| `PASSWORD` | The administrator password.
| `CognitoClientId` | The Cognito Client Id found in the CloudFormation Outputs.
| `AWS_REGION` | The AWS region you installed FormKiQ into (us-east-1, us-east-2, etc)
|=======================================================================


The JSON response should return successful response like below: 
----
{
  ...
  "AuthenticationResult": {
    "AccessToken": "eyJraWQiOiJkdkpnTHlm ...",
  }
  ...
}
----

Using the `AccessToken` value from above, we can create an Environment Variable which we can reuse for all the cURL commands below (skip this step if using an API Client). If you are using an API Client you can add an HTTP Header with key `Authentication` and value of the **ACCESS_TOKEN** instead.
----
export COGNITO_AUTH=<ACCESS_TOKEN>
----

To speed up authentication for future sessions, you can use https://stedolan.github.io/jq[jq], a command-line JSON processor, to receive an access token and set to an environment variable in one line of code:
----
export COGNITO_AUTH=`aws cognito-idp initiate-auth --auth-flow USER_PASSWORD_AUTH \
--auth-parameters USERNAME=<ADMIN_EMAIL>,PASSWORD=<PASSWORD> \
--client-id <CognitoClientId> | jq -r '.AuthenticationResult.AccessToken'`
----

Test your Access Token:
----
aws cognito-idp get-user --access-token $COGNITO_AUTH
----

The JSON response should return successful response like below:
----
{
  "Username": "demo@formkiq.com",
  ...
}
----

*NOTE:* A Cognito `ACCESS_TOKEN` is only good for **1 hour**. For the purposes of this demo, you can run the above login command again if the token expires. 

### A shortcut for your HTTP API URL

To make this demo easier to copy and paste, we reference an additional Environment Variable, for the HTTP API URL. You can create it the same way you created the COGNITO_AUTH variable:
----
export FORMKIQ_API_URL=<FORMKIQ_API_URL>
----
As with COGNITO_AUTH, you would skip this step if you are using an API Client, and would replace any occurrence of "$HttpApiUrl" in the Demo URLs with your actual <FORMKIQ_API_URL>.

## Upload a Document

FormKiQ can receive documents or data in a variety of formats. 

*Note:* Upload POST requests have a filesize limit of 10 MB. For larger files, use GET /documents/upload endpoints which generates an Amazon S3 Presigned URL you can send a PUT request to. See below for an example. 

### Content

Using cURL, upload the document and add a document tag:

----
curl -X POST -H "Content-Type: application/json" -H "Authorization: $COGNITO_AUTH" \
-d '{ "path": "user.json","content": "{\"name\":\"John Smith\"}","tags": [{"key": "content","value": "text"}]}' \
"$HttpApiUrl/documents"
----

The JSON response should provide a Document ID that can be used to make further API requests:
----
{
  "documentId":"07c040e4-7b3d-469d-8182-0ee27b422077"
}
----

### Base64

Document content can be Base64 encoded before uploading. You can use a utility like https://www.base64encode.org or, if you have OpenSSL installed, you can create a quick test document: 
----
echo -n 'This is a test content' | openssl base64
----
The above command should create the following Base64 encoded string: 
----
VGhpcyBpcyBhIHRlc3QgY29udGVudA==
----

Using cURL, upload the document and add a document tag:
----
curl -X POST -H "Content-Type: text/plain" -H "Authorization: $COGNITO_AUTH" \
-d '{ "isBase64":true, "path": "user.json","content": "VGhpcyBpcyBhIHRlc3QgY29udGVudA==","tags": [{"key": "content","value": "text"}]}' \
"$HttpApiUrl/documents"
----

The JSON response should provide a Document ID that can be used to make further API requests:
----
{
  "documentId":"07c040e4-7b3d-469d-8182-0ee27b422077"
}
----

### Large Files
Upload POST requests have a filesize limit of 10 MB. For larger files, you can get a URL that accepts file sizes up to 5GB.

Using cURL, get a document upload url:
----
curl -H "Authorization: $COGNITO_AUTH" "$HttpApiUrl/documents/upload"
----

The JSON response contains a URL you can send a "PUT" request to with your file's contents:
----
{"url":"https://s3.us-east-1.amazonaws.com/...","documentId":"b0ac57b9-59ae-4603-b6f3-013ccb99fdf9"}
----

Using cURL, upload a file:
----
curl -H "Content-Type: text/plain" "https://s3.us-east-1.amazonaws.com/..." --upload-file file.txt
----

## Retrieve Document(s)

Run the following cURL command to retrieve documents that have been added today.
----
curl -H "Authorization: $COGNITO_AUTH" "$HttpApiUrl/documents"
----

You can specify a particular date using:
----
curl -H "Authorization: $COGNITO_AUTH" "$HttpApiUrl/documents?date=2020-05-20"
----

For a nicer formatting in responses, you can pipe the response to jq.
----
curl -H "Authorization: $COGNITO_AUTH" "$HttpApiUrl/documents" | jq
----

JSON response
----
{
  documents: [
    {
    "documentId": "11546f7d-0489-4e92-8763-79c83c0982c1",
    "insertedDate": "...",
    "path": "...",
    "userId": "...",
    "contentType": "...",
    "checksum": "...",
    "contentLength": ...
    },
    ...
  ]
}
----

Run the following cURL command to retrieve information about a specific document:
----
curl -H "Authorization: $COGNITO_AUTH" "$HttpApiUrl/documents/<DOCUMENT_ID>"
----
JSON response
----
{
  "documentId": "11546f7d-0489-4e92-8763-79c83c0982c1",
  "insertedDate": "...",
  "path": "...",
  "userId": "...",
  "contentType": "...",
  "checksum": "...",
  "contentLength": ...
}
----

Run the following cURL command to retrieve a url for accessing a document's content:
----
curl -H "Authorization: $COGNITO_AUTH" "$HttpApiUrl/documents/<DOCUMENT_ID>/url"
----
JSON response
----
{
  "url": "...",
  "documentId": "11546f7d-0489-4e92-8763-79c83c0982c1"
}
----

You can retrieve this document content using a simple cURL command, using only the URL provided in the previous request. There is no Cognito authentication header required, as the time-sensitive authentication is provided by CloudFront within the URL parameters.

## Document Search

Run the following cURL command to search by a specific key:
----
curl -X POST -H "Authorization: $COGNITO_AUTH" -d '{"query": {"tag": {"key": "author"}}}' \
"$HttpApiUrl/search"
----
JSON response
----
{
  "next": "66b0bf4c-d0ba-4db1-a036-5ae6d76c369f",
  "documents": [
    {
      "documentId": "47f84356-c2f4-4e82-b7d8-cb2cd54380f6",
      "insertedDate": "...",
      "path": "...",
      "userId": "...",
      "contentType": "...",
      "checksum": "...",
      "matchedTag": {
        "key": "author",
        "value": "Alejandro Calvo",
        "type": "USERDEFINED"
      }
    },
    {
      "documentId": "59ac692f-f53b-48ac-a43a-a0cbfdb3cda7",
      "insertedDate": "...",
      "path": "...",
      "userId": "...",
      "contentType": "...",
      "checksum": "...",
      "matchedTag": {
        "key": "author",
        "value": "Andrzej Niemojewski",
        "type": "USERDEFINED"
      }
    }
    ...
  ]
}
----

Run the following cURL command to search by a specific key and value:
----
curl -X POST -H "Authorization: $COGNITO_AUTH" \
-d '{"query": {"tag": {"key": "author", "eq": "Andrzej Niemojewski"}}}' \
"$HttpApiUrl/search"
----
JSON response
----
{
  "documents": [
    {
      "documentId": "59ac692f-f53b-48ac-a43a-a0cbfdb3cda7",
      "insertedDate": "...",
      "path": "...",
      "userId": "...",
      "contentType": "...",
      "checksum": "...",
      "matchedTag": {
        "key": "author",
        "value": "Andrzej Niemojewski",
        "type": "USERDEFINED"
      }
    },
    {
      "documentId": "86d33935-833f-43c5-ada0-b95207bbc72c",
      "insertedDate": "...",
      "path": "...",
      "userId": "...",
      "contentType": "...",
      "checksum": "...",
      "matchedTag": {
        "key": "author",
        "value": "Andrzej Niemojewski",
        "type": "USERDEFINED"
      }
    }
  ]
}
----

Run the following cURL command to search using "Begins With" (which is case sensitive):
----
curl -X POST -H "Authorization: $COGNITO_AUTH" \
-d '{"query": {"tag": {"key": "author","beginsWith":"W"}}}' \
"$HttpApiUrl/search"
----
JSON response
----
{
  "next": "c1c9f0f9-9c47-4242-ad31-c75365da2d0e",
  "documents": [
    {
      "documentId": "3eaaed28-b6c3-4658-a1c6-252994819672",
      "insertedDate": "...",
      "path": "...",
      "userId": "...",
      "contentType": "...",
      "checksum": "...",
      "matchedTag": {
        "key": "author",
        "value": "Wilbur S. Peacock",
        "type": "USERDEFINED"
      }
    },
    {
      "documentId": "6bd711b4-8a9d-4503-93b6-93f1bb1f3943",
      "insertedDate": "...",
      "path": "...",
      "userId": "...",
      "contentType": "...",
      "checksum": "...",
      "matchedTag": {
        "key": "author",
        "value": "Wilbur S. Peacock",
        "type": "USERDEFINED"
      }
    }
    ...
  ]
}
----

## Tagging Documents
Document metadata is assigned using tags. A tag is made up of a key and an optional value.

 Run the following cURL command to add a tag to a document:
----
curl -X POST -H "Authorization: $COGNITO_AUTH" \
-d '{"key": "category","value": "test"}' \
"$HttpApiUrl/documents/<DOCUMENT_ID>/tags"
----
JSON response
----
{
  "message": "Created Tag 'category'."
}
----

Run the following cURL command to retrieve a document's tags:
----
curl -H "Authorization: $COGNITO_AUTH" \
"$HttpApiUrl/documents/<DOCUMENT_ID>/tags"
----
JSON response
----
{
  "tags": [
    {
      "key": "author",
      "value": "William Shakespeare",
      "userId": "...",
      "insertedDate": "...",
      "type": "userdefined"
    },
    {
      "key": "path",
      "value": "...",
      "userId": "...",
      "insertedDate": "...",
      "type": "systemdefined"
    },
    {
      "key": "title",
      "value": "Venus and Adonis",
      "userId": "...",
      "insertedDate": "...",
      "type": "userdefined"
    },
  ]
}
----

## Document Versions / Revisions

FormKiQ API makes use of S3 Versions, which keeps track of any change to a document, and allows you to access previous revisions.

Run the following cURL command to view all of the versions of a document:
----
curl -H "Authorization: $COGNITO_AUTH" \
"$HttpApiUrl/documents/<DOCUMENT_ID>/versions"
----
JSON response
----
{
"versions": [
  {
    "versionId": "OKZbnKFXt9L7VtcQFmz4AgBOpjG3YjT4",
    "lastModifiedDate": "2020-06-27T00:05:15+0000"
  }
]
}
----

You can access the document content from a specific version by appending the versionId parameter to your content URL request:
----
curl -H "Authorization: $COGNITO_AUTH" \
"$HttpApiUrl/documents/<DOCUMENT_ID>/url?versionId=<VERSION_ID>
----
JSON response
----
{
  "url": "...",
  "documentId": "d2367e1f-038d-4c8f-9832-ca3bd8c291a1"
}
----

== Summary

Throughout this tutorial, you have successfully used the FormKiQ documents API to add documents, add tags to those documents and be able to search for documents.

To learn more about how you can use the FormKiQ API to collect, organize, process, and integrate your documents and web forms see xref:tutorials:overview.adoc[FormKiQ Tutorials].